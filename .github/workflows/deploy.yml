name: Deploy via SSH

on:
  push:
    branches: [main]
  workflow_dispatch: 

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key

      - name: Deploy via SSH
        id: ssh_step
        run: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –ø–æ SSH"
          ssh -i ~/.ssh/key -o ConnectTimeout=10 -o StrictHostKeyChecking=no cx43946@vh370.timeweb.ru << 'EOF'
            set -e
            cd git.uwtest.ru/public_html
            git pull origin main
            composer install --no-interaction --prefer-dist --optimize-autoloader
          EOF
          ssh_exit_code=$?
          echo "SSH –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –∫–æ–¥–æ–º $ssh_exit_code"

          if [ $ssh_exit_code -ne 0 ]; then
            echo "ssh_failed=true" >> $GITHUB_OUTPUT
          else
            echo "ssh_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Retry workflow if SSH failed
        if: steps.ssh_step.outputs.ssh_failed == 'true'
        run: |
          echo "‚õî –ü–∏–Ω–≥ –Ω–µ –ø—Ä–æ—à—ë–ª. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º workflow —á–µ—Ä–µ–∑ API..."
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/dispatches \
            -d '{"ref":"${{ github.ref_name }}"}'
          exit 1 
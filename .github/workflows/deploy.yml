name: Deploy via SSH

on:
  push:
    branches: [main]
  workflow_dispatch: 

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Add SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/key
          chmod 600 ~/.ssh/key

      - name: Deploy via SSH
        id: ssh_step
        run: |
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –ø–æ SSH"
          
          (
            set +e
            ssh -i ~/.ssh/key -o ConnectTimeout=10 \
                -o StrictHostKeyChecking=no cx43946@vh370.timeweb.ru << 'EOF'
              set -e
              cd git.uwtest.ru/public_html
              git pull origin main
              composer install --no-interaction --prefer-dist --optimize-autoloader
            EOF
            echo $? > ssh_exit_code
          )
      
          # 2) –ß–∏—Ç–∞–µ–º –∏ –≤—ã–≤–æ–¥–∏–º –∫–æ–¥ –≤—ã—Ö–æ–¥–∞
          status=$(< ssh_exit_code)
          echo "SSH –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –∫–æ–¥–æ–º: $status"
      
          # 3) –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º output –¥–ª—è —É—Å–ª–æ–≤–∏–π
          if [ "$status" -ne 0 ]; then
            echo "ssh_failed=true" >> "$GITHUB_OUTPUT"
          else
            echo "ssh_failed=false" >> "$GITHUB_OUTPUT"
          fi

        continue-on-error: true

      - name: Retry workflow if SSH failed
        if: steps.ssh_step.outputs.ssh_failed == 'true'
        run: |
          echo "‚õî –ü–∏–Ω–≥ –Ω–µ –ø—Ä–æ—à—ë–ª. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º workflow —á–µ—Ä–µ–∑ API..."
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/deploy.yml/dispatches \
            -d '{"ref":"${{ github.ref_name }}"}'
          exit 1 